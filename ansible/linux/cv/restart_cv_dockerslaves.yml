---
- hosts: all
  gather_facts: False

  vars:
    ansible_user: couchbase
    ansible_pass: couchbase

  tasks:
    - name: Update build repo
      git:
        repo: git://github.com/couchbase/build
        dest: /home/couchbase/build

    - name: Remove old jenkinsdocker-ssh
      file:
        name: /home/couchbase/jenkinsdocker-ssh
        state: absent

    - name: Copy new jenkinsdocker-ssh
      copy:
        src: /home/couchbase/jenkinsdocker-ssh
        dest: /home/couchbase

    - name: Ensure cronscript exists
      file:
        path: /home/couchbase/cronscript
        state: touch

    - name: Add doc comment to cronscript
      lineinfile:
        path: /home/couchbase/cronscript
        regexp: "NOTICE"
        line: "# NOTICE: Automatically generated by build-infra/ansible/linux/cv"

    - include_tasks: add_docker_slave.yml
      vars:
        ccache_dir: /home/couchbase/slaves/{{ slave.slave_name }}_ccache
        restart_cmd: >-
          /home/couchbase/build/docker/scripts/restart_jenkinsdocker.py
          {{ slave.docker_image }}
          {{ slave.slave_name }}
          {{ slave.port | default('2222') }}
          cv.jenkins.couchbase.com
          --ccache-dir {{ ccache_dir }}
      loop: "{{ slaves }}"
      loop_control:
        loop_var: slave

    - name: "{{ item.slave_name }} - Remove unused docker images and data"
      shell: "docker system prune --all --force"

    - name: Add disk-check cron job
      cron:
        name: "check diskspace"
        minute: "0"
        job: "/bin/bash /home/couchbase/cronscript"

    - name: Add public SSH keys for easy access
      copy:
        src: authorized_keys
        dest: /home/couchbase/.ssh
        mode: 0600
